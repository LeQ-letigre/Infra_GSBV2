---
- name: Configuration des VLANs sur les switchs Planet
  hosts: switchs
  gather_facts: no
  serial: 1  # IMPORTANT: Une seule connexion SSH a la fois

  vars:
    lock_file: "/tmp/switch_ansible.lock"
    ansible_ssh_common_args: '-o ControlMaster=no'

  tasks:
    - name: Verifier que les variables sont definies
      ansible.builtin.assert:
        that:
          - vlan_id is defined
          - vlan_name is defined
        fail_msg: "Erreur : Les variables vlan_id et vlan_name doivent etre definies"
      run_once: true
      delegate_to: localhost

    - name: Determiner les ports pour ce switch
      ansible.builtin.set_fact:
        my_access_ports: "{{ (lookup('vars', inventory_hostname + '_access', default='[]') | from_json) if lookup('vars', inventory_hostname + '_access', default='[]') is string else lookup('vars', inventory_hostname + '_access', default=[]) }}"
        my_trunk_ports: "{{ (lookup('vars', inventory_hostname + '_trunk', default='[]') | from_json) if lookup('vars', inventory_hostname + '_trunk', default='[]') is string else lookup('vars', inventory_hostname + '_trunk', default=[]) }}"

    - name: Afficher les informations du VLAN
      ansible.builtin.debug:
        msg: |
          Configuration du VLAN sur {{ inventory_hostname }}
          - VLAN ID   : {{ vlan_id }}
          - VLAN Name : {{ vlan_name }}
          - Ports Access : {{ my_access_ports }}
          - Ports Trunk  : {{ my_trunk_ports }}

    - name: Creer le VLAN sur le switch
      ansible.builtin.shell: |
        expect << 'EOF'
        set timeout 30
        log_user 1
        spawn ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o ControlMaster=no {{ ansible_user }}@{{ ansible_host }}
        expect {
          "Press <Enter> to continue..." { send "\r" }
          "Username:" { send "{{ ansible_user }}\r" }
          timeout { exit 1 }
        }
        expect {
          "Username:" { send "{{ ansible_user }}\r" }
          "Password:" { send "{{ ansible_password }}\r" }
          timeout { exit 1 }
        }
        expect {
          "Password:" { send "{{ ansible_password }}\r" }
          "#" { }
          timeout { exit 1 }
        }
        expect "#"
        send "configure\r"
        sleep 1
        send "vlan {{ vlan_id }}\r"
        sleep 1
        send "name {{ vlan_name }}\r"
        sleep 1
        send "exit\r"
        sleep 1
        send "exit\r"
        sleep 1
        send "exit\r"
        expect eof
        EOF
      delegate_to: localhost
      register: vlan_creation
      changed_when: true

    - name: Attendre stabilisation
      ansible.builtin.pause:
        seconds: 1

    - name: Configurer les ports en mode access
      ansible.builtin.shell: |
        expect << 'EOF'
        set timeout 30
        log_user 1
        spawn ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o ControlMaster=no {{ ansible_user }}@{{ ansible_host }}
        expect {
          "Press <Enter> to continue..." { send "\r" }
          "Username:" { send "{{ ansible_user }}\r" }
          timeout { exit 1 }
        }
        expect {
          "Username:" { send "{{ ansible_user }}\r" }
          "Password:" { send "{{ ansible_password }}\r" }
          timeout { exit 1 }
        }
        expect {
          "Password:" { send "{{ ansible_password }}\r" }
          "#" { }
          timeout { exit 1 }
        }
        expect "#"
        send "configure\r"
        sleep 1
        send "interface {{ item }}\r"
        sleep 1
        send "switchport mode access\r"
        sleep 1
        send "switchport access vlan {{ vlan_id }}\r"
        sleep 1
        send "exit\r"
        sleep 1
        send "exit\r"
        sleep 1
        send "exit\r"
        expect eof
        EOF
      delegate_to: localhost
      loop: "{{ my_access_ports }}"
      when: my_access_ports | length > 0
      register: access_config

    - name: Configurer les ports en mode trunk
      ansible.builtin.shell: |
        expect << 'EOF'
        set timeout 30
        log_user 1
        spawn ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o ControlMaster=no {{ ansible_user }}@{{ ansible_host }}
        expect {
          "Press <Enter> to continue..." { send "\r" }
          "Username:" { send "{{ ansible_user }}\r" }
          timeout { exit 1 }
        }
        expect {
          "Username:" { send "{{ ansible_user }}\r" }
          "Password:" { send "{{ ansible_password }}\r" }
          timeout { exit 1 }
        }
        expect {
          "Password:" { send "{{ ansible_password }}\r" }
          "#" { }
          timeout { exit 1 }
        }
        expect "#"
        send "configure\r"
        sleep 1
        send "interface {{ item }}\r"
        sleep 1
        send "switchport mode trunk\r"
        sleep 1
        send "switchport trunk allowed vlan add {{ vlan_id }}\r"
        sleep 1
        send "exit\r"
        sleep 1
        send "exit\r"
        sleep 1
        send "exit\r"
        expect eof
        EOF
      delegate_to: localhost
      loop: "{{ my_trunk_ports }}"
      when: my_trunk_ports | length > 0
      register: trunk_config

    - name: Afficher le resume
      ansible.builtin.debug:
        msg: |
          ================================================================
          Configuration VLAN terminee sur {{ inventory_hostname }}
          ================================================================

          VLAN {{ vlan_id }} ({{ vlan_name }}) cree avec succes

          Ports configures en mode Access (VLAN {{ vlan_id }}) :
          {% if my_access_ports | length > 0 %}
          {% for port in my_access_ports %}
          - {{ port }}
          {% endfor %}
          {% else %}
          - Aucun
          {% endif %}

          Ports configures en mode Trunk (VLAN {{ vlan_id }} ajoute) :
          {% if my_trunk_ports | length > 0 %}
          {% for port in my_trunk_ports %}
          - {{ port }}
          {% endfor %}
          {% else %}
          - Aucun
          {% endif %}
